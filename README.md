# Claude Project Scaffold

A scaffolding system for AI-driven software development with Claude Code agents.

## Overview

This scaffold provides a structured workflow for greenfield project development using Claude Code. It implements:

- **Two-agent architecture**: Initialization and development loop separation
- **TDD enforcement**: Tests before implementation with immutable test contracts
- **Memory persistence**: Session history and architectural decisions across context windows
- **Quality gates**: Hook-based enforcement at workflow boundaries
- **Subagent orchestration**: Specialized agents for planning, testing, implementation, review, and memory updates

## Scaffold Structure

```
scaffold/
├── .claude/
│   ├── agents/          # Specialized subagents
│   ├── commands/        # Workflow commands (/next, /plan, etc.)
│   ├── hooks/           # Quality gate scripts
│   ├── rules/           # File protection policies
│   ├── skills/          # Extended capabilities
│   │   ├── dev/         # Session start (with resume support)
│   │   ├── init-repo/   # One-time scaffold initialization
│   │   └── summarize/   # Context handoff
│   └── settings.json    # Hook configuration
├── _docs/               # Core documentation (read-only for agents)
│   ├── prd.md           # Product requirements template
│   ├── architecture.md  # System design template
│   ├── task-list.json   # Development tasks
│   ├── best-practices.md # Coding standards
│   └── backlog.json     # Deferred issues registry
├── _scripts/            # Git hooks and setup scripts
│   └── pre-commit       # Git pre-commit hook (requires installation)
├── _context-summaries/  # Session handoff summaries (generated by /summarize)
├── progress.md          # Append-only session history
├── decisions.md         # Append-only decision log
├── CLAUDE.md            # Project context for Claude Code
└── .mcp.json            # MCP server configuration
```

## Development Workflow

1. `/dev [summary]` - Start development session (optionally resume from summary)
2. `/next` - Select next task
3. `/plan` - Plan implementation
4. `/test` - Write failing tests
5. `/implement` - Make tests pass
6. `/review` - Code review
7. `/commit` - Commit and update memory

**Note**: Run `/init-repo` once after placing project documentation to initialize memory files (`progress.md`, `decisions.md`) and validate core docs. Environment setup (dependency installation, dev server configuration) is handled through the first tasks in `task-list.json`.

## Context Management

Claude Code has a 200k token context limit. When context fills, use `/summarize` to hand off to a new agent.

### Monitoring Context

Run `/context` periodically to check usage. Recommended handoff threshold: 70%.

### Handoff Workflow

1. Run `/summarize` when context is filling
2. Skill captures: completed work, in-progress state, decisions, files modified, key resources
3. Spawn new agent
4. Run `/dev _context-summaries/[timestamp].md` to resume

### Session Chaining

The `/summarize` skill automatically detects if the current session resumed from a prior summary. When chaining sessions:

- Resources are carried forward with lineage tracking
- Session chain history is preserved
- Stale resources are pruned
- Full chain table maintained in each summary

### Why Not Auto-Compaction?

Auto-compaction is lossy and may discard task-specific state. Manual `/summarize` ensures:
- Explicit control over what persists
- Resource links preserved
- Session chain traceable
- Clean handoff to new agent

## Design Decisions

Decisions made during scaffold development are recorded below.

### Decision Log

#### 2025-01-25: Manual Context Loading via /dev

**Context**: Evaluated whether to add a SessionStart hook for automatic context injection at session start.

**Decision**: Keep manual context loading via `/dev` command.

**Rationale**:
- Not all orchestrator sessions require full project context
- Some sessions may be quick questions or unrelated tasks
- Explicit `/dev` command gives users control over when to initialize the orchestrator as a development partner
- Reduces unnecessary token overhead for short sessions

**Alternative Considered**: SessionStart hook to auto-inject progress.md and task state. Rejected because automatic injection assumes all sessions are development sessions.

---

#### 2025-01-25: Git Pre-Commit Hook for Quality Gates

**Context**: Quality gates need to run before code is committed. Initially considered a Claude Stop hook, but this would run on every response (including simple questions), causing unnecessary latency.

**Decision**: Use git pre-commit hook as the single enforcement point.

**Implementation**:
| Hook | Location | Trigger | Purpose |
|------|----------|---------|---------|
| pre-commit | `_scripts/pre-commit` | `git commit` | Runs test, lint, typecheck before commit |

**Installation** (required after cloning):
```bash
cp _scripts/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

**Rationale**:
- Git commit is the correct enforcement boundary—nothing commits without passing
- Avoids unnecessary checks on non-commit operations (`/dev`, `/next`, Q&A)
- Single source of truth for quality gate logic
- Works regardless of commit source (Claude or human)

**Alternative Rejected**: Claude Stop hook running on every response. This caused 10-30s delays after every interaction, even simple questions.

---

#### 2026-01-26: /init-repo Skill for Scaffold Initialization

**Context**: Setup responsibilities (doc validation, memory file creation, backlog.json) were initially placed in `task-list.json` as TASK-001 through TASK-003. However, these are scaffold infrastructure tasks, not project features -- they don't belong in the user's task list.

**Decision**: Create `/init-repo` skill for one-time scaffold initialization. Remove setup tasks from `task-list.json`.

**Implementation**:
- `/init-repo` skill validates core docs, creates `progress.md`, `decisions.md`, `backlog.json`
- `/dev` requires initialization (reports and stops if memory files missing)
- `task-list.json` template contains only placeholder project tasks
- Environment setup (dependencies, dev server) remains as first user task in task list

**Rationale**:
- Scaffold infrastructure tasks should not modify the user's task list
- One-time setup is invoked explicitly, not discovered through `/next`
- User controls when initialization runs
- Clean separation: /init-repo = scaffold setup, task-list.json = project work

**Alternative Rejected**: Keeping setup tasks in task-list.json. This modifies the user's file with scaffold concerns and conflates infrastructure with project work.

---

#### 2026-01-26: Task-Selector Subagent for Context Isolation

**Context**: The `/next` command previously read `task-list.json` directly, pulling the full task list into the orchestrator's context window.

**Decision**: Create `task-selector` subagent to isolate task-list.json reads from the orchestrator.

**Implementation**:
- `.claude/agents/task-selector.md` reads task-list.json and returns only the selected task
- `/next` spawns task-selector instead of reading the file directly
- `/dev` verifies task-list.json exists but does not read contents

**Rationale**:
- Task list can be large; loading it pollutes the orchestrator's context
- Subagent explores extensively but returns only a condensed selection
- Aligns with context isolation principle from best practices manual

**Alternative Rejected**: Continue reading task-list.json directly in /next. This pulls unnecessary content into the orchestrator's limited context window.

---

## Best Practices Alignment

This scaffold follows the AI-Assisted Development Best Practices Manual (v2). Key alignments:

| Practice | Implementation |
|----------|----------------|
| CLAUDE.md under 60 lines | ~53 lines |
| Path-scoped rules | 5 rules in `.claude/rules/` |
| Structured subagent output | All agents define exact output format |
| Test immutability | Triple enforcement: rule + hook + agent instruction |
| Append-only memory | progress.md and decisions.md |
| Hook-based quality gates | Advisory (PostToolUse) + Git pre-commit |

## Personal Overrides (CLAUDE.local.md)

Create a `CLAUDE.local.md` file in the project root for personal project-specific preferences. Claude Code automatically adds this file to .gitignore.

**Appropriate content:**
- Sandbox URLs and local environment endpoints
- Preferred test data and fixtures
- Personal workflow preferences
- Local tool paths or configurations

**Alternative for git worktrees:** Import from home directory instead, which works better across multiple worktrees:
```markdown
# In CLAUDE.md
@~/.claude/my-project-preferences.md
```

**Inappropriate content:**
- Project architecture decisions (use CLAUDE.md)
- Code style rules (use linters and hooks)
- Task-specific instructions (use path-scoped rules)

## Known Gaps and Future Improvements

Items identified for potential enhancement:

- [x] ~~Extract initializer subagent from /init command~~ (resolved: /init-repo skill for scaffold setup; task-selector subagent for context isolation)
- [x] ~~Add CLAUDE.local.md template for personal overrides~~ (documented above)
- [x] ~~Document context clearing strategy~~ (consolidated into /dev; removed /catchup)
- [ ] Integrate Explore subagent for read-only context gathering (R6)
- [ ] Strengthen agent descriptions with when-to-use framing (R7)
- [ ] Add SubagentStop hook for progress tracking (R8)
- [ ] Add end-to-end testing guidance with puppeteer MCP (R9)

## References

- [AI-Assisted Development Best Practices Manual](../ai-development-best-practices-manual-v2.md)
- [Claude Code Documentation](https://docs.anthropic.com/claude-code)
