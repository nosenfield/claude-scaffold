#!/bin/bash
# Git Pre-Commit Hook
# Runs quality checks and creates marker for bypass detection
#
# Features:
# - Runs test, lint, and typecheck if available
# - Creates marker file for post-commit bypass detection
#
# Installation:
#   git config core.hooksPath _scripts
#
# Or copy hooks manually:
#   cp _scripts/pre-commit .git/hooks/pre-commit
#   cp _scripts/post-commit .git/hooks/post-commit

set -o pipefail

# Marker for bypass detection (validated by post-commit)
MARKER_FILE="_logs/.pre-commit-ran"
MARKER_SIGNATURE="pre-commit-hook-v1"
mkdir -p _logs

echo "=== Git Pre-Commit Quality Check ==="
echo ""

# Track failures
FAILED=0

# Run test suite
if [ -f "package.json" ] && grep -q '"test"' package.json 2>/dev/null; then
    echo "Running tests..."
    if ! npm run test --silent 2>&1; then
        echo "ERROR: Tests failed" >&2
        FAILED=1
    else
        echo "Tests passed"
    fi
fi

# Run linter
if [ -f "package.json" ] && grep -q '"lint"' package.json 2>/dev/null; then
    echo "Running lint..."
    if ! npm run lint --silent 2>&1; then
        echo "ERROR: Lint failed" >&2
        FAILED=1
    else
        echo "Lint passed"
    fi
fi

# Run type check
if [ -f "package.json" ] && grep -q '"typecheck"' package.json 2>/dev/null; then
    echo "Running typecheck..."
    if ! npm run typecheck --silent 2>&1; then
        echo "ERROR: Type check failed" >&2
        FAILED=1
    else
        echo "Type check passed"
    fi
elif [ -f "tsconfig.json" ]; then
    echo "Running tsc..."
    if ! npx tsc --noEmit 2>&1; then
        echo "ERROR: Type check failed" >&2
        FAILED=1
    else
        echo "Type check passed"
    fi
fi

# Exit with failure if any check failed
if [ $FAILED -ne 0 ]; then
    echo ""
    echo "Pre-commit checks failed. Fix issues before committing." >&2
    exit 1
fi

echo ""
echo "All pre-commit checks passed"

# Create marker for post-commit bypass detection
echo "$MARKER_SIGNATURE" > "$MARKER_FILE"

exit 0
